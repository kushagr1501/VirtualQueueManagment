// import express from "express";
// import Queue from "../models/Queue.js";
// import Place from "../models/Place.js";

// const router = express.Router();

// export default (io) => {


//   // Get queue for a specific place
//   router.get("/place/:placeId", async (req, res) => {
//     const queue = await Queue.find({ placeId: req.params.placeId, status: "waiting" });
//     res.json(queue);
//   });
//   // Get a specific place by ID
// router.get("/places/:id", async (req, res) => {
//   try {
//     const place = await Place.findById(req.params.id);
//     if (!place) return res.status(404).json({ message: "Place not found" });
//     res.json(place);
//   } catch (err) {
//     res.status(500).json({ message: "Error fetching place", error: err.message });
//   }
// });

// function generateRandomCode() {
//   return Math.floor(100000 + Math.random() * 900000).toString(); // 6-digit code
// }

//   // Join queue
//   router.post("/place/:placeId/join", async (req, res) => {
//     const { userName, queueName = "default" } = req.body;
  
//     // prevent duplicate entry in the same queue
//     const existingEntry = await Queue.findOne({
//       userName,
//       placeId: req.params.placeId,
//       queueName,
//       status: "waiting",
//     });
  
//     if (existingEntry) {
//       return res.status(409).json({ message: "Already joined this queue", _id: existingEntry._id, verificationCode: existingEntry.verificationCode });
//     }
  
//     const entry = new Queue({
//       userName,
//       placeId: req.params.placeId,
//       queueName,
//       verificationCode: generateRandomCode()
//     });
  
//     await entry.save();
  
//     const updatedQueue = await Queue.find({
//       placeId: req.params.placeId,
//       status: "waiting",
//       queueName
//     });
  
//     io.to(req.params.placeId).emit("queueUpdate", updatedQueue);
//     res.status(201).json(entry);
//   });
  
  

//   // Leave queue
//   router.post("/leave/:id", async (req, res) => {
//     await Queue.findByIdAndUpdate(req.params.id, { status: "cancelled" });
//     res.json({ message: "Left queue" });
//   });

//   // Serve user (admin only)
//   router.patch("/serve/:id", async (req, res) => {
//     const updated = await Queue.findByIdAndUpdate(req.params.id, { status: "served" }, { new: true });
//     const queue = await Queue.find({ placeId: updated.placeId, status: "waiting" });
//     io.to(updated.placeId.toString()).emit("queueUpdate", queue);
//     res.json(updated);
//   });
//   // Add new place
//   router.post("/places", async (req, res) => {
//     const { name, description, location, businessId } = req.body;
  
//     if (!name || !description || !location || !businessId) {
//       return res.status(400).json({ message: "Missing required fields" });
//     }
  
//     const place = new Place({ name, description, location, businessId });
//     await place.save();
//     res.status(201).json(place);
//   });
  
// router.delete("/queue/delete-all/:placeId", async (req, res) => {
//   await Queue.deleteMany({ placeId: req.params.placeId, status: "waiting" });
//   const updatedQueue = await Queue.find({ placeId: req.params.placeId, status: "waiting" });
//   io.to(req.params.placeId).emit("queueUpdate", updatedQueue);
//   res.json({ message: "Queue cleared" });
// });



// // Get a specific place by ID
// router.get("/places", async (req, res) => {
//   const { businessId } = req.query;
//   const filter = businessId ? { businessId } : {};

//   const places = await Place.find(filter);

//   // for each place, fetch queue count
//   const placesWithQueueCount = await Promise.all(
//     places.map(async (place) => {
//       const queueCount = await Queue.countDocuments({
//         placeId: place._id,
//         status: "waiting",
//       });
//       return { ...place.toObject(), queueCount };
//     })
//   );

//   res.json(placesWithQueueCount);
// });
// //staff ppl
// router.get("/queue/find-by-code/:code", async (req, res) => {
//   const entry = await Queue.findOne({ verificationCode: req.params.code });

//   if (!entry) return res.status(404).json({ message: "Queue entry not found" });

//   res.json(entry);
// });

// router.patch("/queue/:id/verify", async (req, res) => {
//   const updated = await Queue.findByIdAndUpdate(
//     req.params.id,
//     {
//       isVerified: true,
//       verifiedAt: new Date()
//     },
//     { new: true }
//   );

//   // Emit update to frontend if needed
//   io.to(updated.placeId.toString()).emit("queueUpdate");

//   res.json(updated);
// });



// // Get multiple queue entries by an array of verification codes
// router.post("/queues/by-codes", async (req, res) => {
//   const { codes } = req.body;
//   if (!codes || !Array.isArray(codes)) {
//     return res.status(400).json({ message: "Codes array required" });
//   }

//   try {
//     const queues = await Queue.find({
//       verificationCode: { $in: codes },
//       status: "waiting"
//     });
//     res.json(queues);
//   } catch (err) {
//     res.status(500).json({ message: "Failed to fetch queues", error: err.message });
//   }
// });


// router.get("/place/:placeId", async (req, res) => {
//   try {
//     const queueName = req.query.queueName || "default";
//     const queue = await Queue.find({
//       placeId: req.params.placeId,
//       status: "waiting",
//       queueName
//     });
//     res.json(queue);
//   } catch (err) {
//     console.error("Error fetching queue:", err);
//     res.status(500).json({ message: "Failed to fetch queue" });
//   }
// });




// // Create a new named queue under a place
// router.post("/places/:placeId/queues", async (req, res) => {
//   const { queueName } = req.body;

//   if (!queueName || typeof queueName !== "string") {
//     return res.status(400).json({ message: "Queue name is required" });
//   }

//   try {
//     const existing = await Queue.findOne({
//       placeId: req.params.placeId,
//       queueName,
//     });

//     if (existing) {
//       return res.status(400).json({ message: "Queue already exists" });
//     }

//     // Insert a dummy entry to register the queue name (optional - just a naming convention)
//     await new Queue({
//       placeId: req.params.placeId,
//       queueName,
//       userName: "__system__",
//       status: "placeholder",
//       verificationCode: "__none__",
//     }).save();

//     res.status(201).json({ message: "Queue created" });
//   } catch (err) {
//     console.error("Queue creation failed:", err);
//     res.status(500).json({ message: "Queue creation failed" });
//   }
// });
// //Return list of distinct queue names for a place
// router.get("/places/:placeId/queues", async (req, res) => {
//   try {
//     const queueNames = await Queue.distinct("queueName", {
//       placeId: req.params.placeId,
//     });
//     res.json(queueNames);
//   } catch (err) {
//     console.error("Failed to fetch queue names:", err);
//     res.status(500).json({ message: "Error fetching queue names" });
//   }
// });

//   return router;
// };
